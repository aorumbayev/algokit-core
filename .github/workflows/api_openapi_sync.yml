name: API OpenAPI Sync
# This workflow runs weekly to check if the OpenAPI specifications need to be converted
# and ensures the generated code is up to date. It processes algod and indexer in parallel.

on:
  schedule:
    # Runs every Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  openapi_conversion:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        spec: [algod, indexer]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-api-tools
      
      - name: Store initial state for ${{ matrix.spec }}
        run: git status --porcelain > /tmp/initial_${{ matrix.spec }}_status.txt
      
      - name: Convert ${{ matrix.spec }} OpenAPI specification
        run: cargo api convert-openapi --${{ matrix.spec }}-only
      
      - name: Check for ${{ matrix.spec }} changes
        run: |
          git status --porcelain > /tmp/post_${{ matrix.spec }}_status.txt
          if [ -s /tmp/post_${{ matrix.spec }}_status.txt ]; then
            echo "âŒ ${{ matrix.spec }} OpenAPI sync needed!"
            echo "ğŸ”§ Run 'cargo api convert-openapi --${{ matrix.spec }}-only' locally and commit"
            git diff
            exit 1
          else
            echo "âœ… ${{ matrix.spec }} OpenAPI sync passed"
          fi
