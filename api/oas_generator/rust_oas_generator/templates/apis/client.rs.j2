#![allow(clippy::let_and_return)]

{% set client_type = get_client_type(spec) %}
/*
 * {{ spec.info.title }}
 *
 * {{ spec.info.description or "API client generated from OpenAPI specification" }}
 *
 * The version of the OpenAPI document: {{ spec.info.version }}
 {% if spec.info.contact and spec.info.contact.email %} * Contact: {{ spec.info.contact.email }}
 {% endif %} * Generated by: Rust OpenAPI Generator
 */

use super::Error;
use algokit_http_client::{DefaultHttpClient, HttpClient};
use std::sync::Arc;
{% if collect_parameter_enums(operations) %}
use super::parameter_enums::*;
{% endif %}
{% if operations %}
{% set used_types = [] %}
{% for operation in operations %}
    {% set operation_types = get_operation_used_types(operation) %}
    {% for type_name in operation_types %}
        {% if type_name not in used_types %}
            {% set _ = used_types.append(type_name) %}
        {% endif %}
    {% endfor %}
    {# Also collect request body types #}
    {% if has_request_body(operation) %}
        {% set request_body_type = get_request_body_type(operation) %}
        {% if request_body_type and should_import_request_body_type(request_body_type) and request_body_type not in used_types %}
            {% set _ = used_types.append(request_body_type) %}
        {% endif %}
    {% endif %}
{% endfor %}
{% if used_types %}
use crate::models::{
{% for used_type in used_types %}
    {{ used_type }},
{% endfor %}
};
{% endif %}
{% endif %}

/// The main {{ client_type }} API client.
///
/// This client provides convenient access to all {{ client_type }} API endpoints.
/// It wraps the lower-level endpoint functions with a more ergonomic interface.
/// All methods return a unified `Error` type that can represent any endpoint error.
#[derive(Clone)]
#[cfg_attr(feature = "ffi_uniffi", derive(uniffi::Object))]
pub struct {{ client_type }}Client {
    http_client: Arc<dyn HttpClient>,
}

{% for impl_block in ["common", "rust", "ffi"] %}
{% if impl_block in ["common", "ffi"] %}
#[cfg_attr(feature = "ffi_uniffi", uniffi::export)]
{% endif %}
{% if impl_block == "rust" %}
#[cfg(not(feature = "ffi_uniffi"))]
{% endif %}
{% if impl_block == "ffi" %}
#[cfg(feature = "ffi_uniffi")]
{% endif %}
impl {{ client_type }}Client {
{% if impl_block == "common" %}
    /// Create a new {{ client_type }}Client with a custom http client.
    #[cfg_attr(feature = "ffi_uniffi", uniffi::constructor)]
    pub fn new(http_client: Arc<dyn HttpClient>) -> Self {
        Self { http_client }
    }

    /// Create a new {{ client_type }}Client for Algorand TestNet.
    #[cfg(feature = "default_client")]
    #[cfg_attr(feature = "ffi_uniffi", uniffi::constructor)]
    pub fn testnet() -> Self {
        let http_client = Arc::new(DefaultHttpClient::new(
            {% if client_type == "Indexer" %}"https://testnet-idx.4160.nodely.dev"{% else %}"https://testnet-api.4160.nodely.dev"{% endif %}
        ));
        Self::new(http_client)
    }

    /// Create a new {{ client_type }}Client for Algorand MainNet.
    #[cfg(feature = "default_client")]
    #[cfg_attr(feature = "ffi_uniffi", uniffi::constructor)]
    pub fn mainnet() -> Self {
        let http_client = Arc::new(DefaultHttpClient::new(
            {% if client_type == "Indexer" %}"https://mainnet-idx.4160.nodely.dev"{% else %}"https://mainnet-api.4160.nodely.dev"{% endif %}
        ));
        Self::new(http_client)
    }

    /// Create a new {{ client_type }}Client for a local localnet environment.
    #[cfg(feature = "default_client")]
    #[cfg_attr(feature = "ffi_uniffi", uniffi::constructor)]
    pub fn localnet() -> Self {
        let http_client = Arc::new(DefaultHttpClient::with_header(
            {% if client_type == "Indexer" %}"http://localhost:8980"{% else %}"http://localhost:4001"{% endif %},
            {% if client_type == "Indexer" %}"X-Indexer-API-Token"{% else %}"X-Algo-API-Token"{% endif %},
            "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
        ).expect("Failed to create HTTP client with API token header"));
        Self::new(http_client)
    }
{% endif %}
{% for operation in operations %}
{% if (impl_block == "common" and not operation.has_optional_string) or (impl_block != "common" and operation.has_optional_string) %}
    {% if operation.summary %}
    /// {{ operation.summary }}
    {% elif operation.description %}
    /// {{ operation.description | replace('\n', '\n    /// ') }}
    {% endif %}
    {% if operation.deprecated %}
    #[deprecated]
    {% endif %}
    pub async fn {{ operation.rust_function_name }}(
        &self,
    {% if has_request_body(operation) %}
        {% set request_body_name = get_request_body_name(operation) %}
        {% set request_body_type = get_request_body_type(operation) %}
        {% if is_request_body_required(operation) %}{{ request_body_name }}: {{ request_body_type }},
        {% else %}{{ request_body_name }}: Option<{{ request_body_type }}>,
        {% endif %}
    {% endif %}
    {% for param in operation.parameters %}
        {% if param.is_enum_parameter %}
        {% if param.required %}{{ param.rust_name }}: {{ param.rust_enum_type }},
        {% else %}{{ param.rust_name }}: Option<{{ param.rust_enum_type }}>,
        {% endif %}
        {% else %}
        {% if param.required %}{{ param.rust_name }}: {% if param.rust_type == "String" %}&str{% else %}{{ param.rust_type }}{% endif %},
        {% else %}{{ param.rust_name }}: Option<{% if param.rust_type == "String" %}{% if impl_block == "ffi" %}String{% else %}&str{% endif %}{% else %}{{ param.rust_type }}{% endif %}>,
        {% endif %}
        {% endif %}
    {% endfor %}
    ) -> Result<{% if get_success_response_type(operation) %}{% if get_success_response_type(operation) == "UnknownJsonValue"
    %}UnknownJsonValue{% else %}{{
    get_success_response_type(operation) }}{% endif %}{% else %}(){% endif %}, Error> {
        let result = super::{{ operation.rust_function_name }}::{{ operation.rust_function_name }}(
            self.http_client.as_ref(),
        {% if has_request_body(operation) %}
            {{ get_request_body_name(operation) }},
        {% endif %}
        {% for param in operation.parameters %}
            {% if impl_block == "ffi" and (not param.required) and (not param.is_enum_parameter) and (param.rust_type == "String") %}
            {{ param.rust_name }}.as_deref(),
            {% else %}
            {{ param.rust_name }},
            {% endif %}
        {% endfor %}
        ).await;

        {% if get_success_response_type(operation) == "UnknownJsonValue" %}
        #[cfg(feature = "ffi_uniffi")]
        {
          result.map(|v| {
            serde_json::to_string(&v).map_err(|e| Error::Serde {
                message: e.to_string(),
            })
          })?
        }

        #[cfg(not(feature = "ffi_uniffi"))]
        {
          result
        }
        {% else %}
          result
        {% endif %}
    }

{% endif %}
{% endfor %}
}

{% endfor %}
